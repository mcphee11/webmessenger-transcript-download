"use strict";let gc_socket,gc_token,gc_icon;function setupWSS(){try{gc_socket=new WebSocket(`wss://webmessaging.${gc_region}/v1?deploymentId=${gc_deploymentId}`),gc_socket.onmessage=async function(e){let t=JSON.parse(e.data);if(console.log(t),"SessionResponse"===t.class){let e={action:"getJwt",token:gc_token};gc_socket.send(JSON.stringify(e))}"JwtResponse"===t.class&&getHistory(t.body.jwt)},console.log(`Waiting for events on wss://webmessaging.${gc_region}/v1?deploymentId=${gc_deploymentId}`),gc_socket.onopen=function(){let e={action:"configureSession",deploymentId:`${gc_deploymentId}`,token:gc_token};gc_socket.send(JSON.stringify(e))}}catch(e){console.error("Websocket error: ",e)}}async function getHistory(e){let t=await fetch(`https://api.${gc_region}/api/v2/webmessaging/messages`,{headers:{Authorization:`Bearer ${e}`}}),n=await t.json();console.log(n),createPdf(n)}async function createPdf(e){const t=await fetch("https://pdf-lib.js.org/assets/ubuntu/Ubuntu-R.ttf").then((e=>e.arrayBuffer())),n=await PDFLib.PDFDocument.create();n.registerFontkit(fontkit);const o=await n.embedFont(t);let i=n.addPage();const{width:a,height:r}=i.getSize(),c=12;let g=150,d=3;if(0===e.total)return console.warn("There are no messages currently"),loadingOff(),void showError();for(const t of e.entities.reverse()){let e,s=1;if(t?.content&&"Attachment"==t.content[0].contentType){if("Image"==t.content[0].attachment.mediaType&&t.content[0].attachment.mime.includes("jpeg")){const o=await fetch(t.content[0].attachment.url).then((e=>e.arrayBuffer()));e=await n.embedJpg(o),e.height>g&&(s=g/e.height)}if("Image"==t.content[0].attachment.mediaType&&t.content[0].attachment.mime.includes("png")){const o=await fetch(t.content[0].attachment.url).then((e=>e.arrayBuffer()));e=await n.embedPng(o),e.height>g&&(s=g/e.height)}}if(t.text){if(newPageNeeded_rec_txt(i,o,t.text,d,a,r,c).value&&(i=n.addPage(),d=3),"Outbound"==t.direction){d=agentText(i,o,t.text,d,a,r,c,t.channel.time)}if("Inbound"==t.direction){d=customerText(i,o,t.text,d,a,r,c,t.channel.time)}}if(e){if(newPageNeeded_rec_img(i,d,r,e.scale(s).height,c)&&(i=n.addPage(),d=3),"Outbound"==t.direction){d=agentImage(i,o,e,s,d,a,r,c,t.channel.time)}if("Inbound"==t.direction){d=customerImage(i,o,e,s,d,a,r,c,t.channel.time)}}}n.setCreationDate(new Date),n.setAuthor("https://github.com/mcphee11"),n.setSubject("Messaging transcript");const s=await n.saveAsBase64({dataUri:!0}),l=document.createElement("a");l.href=s,l.download="transcript.pdf",l.click(),loadingOff()}function customerText(e,t,n,o,i,a,r,c){let g=o+2,d=g+1,s=newPageNeeded_rec_txt(e,t,n,o,i,a,r);e.drawText("Customer",{x:20,y:a-o*r,size:r,font:t});let l={x:20,y:a-g*r,maxWidth:i-40,wordBreaks:[" "],font:t,size:r,lineHeight:r};e.drawRectangle({x:10,y:a-d*r-s.rec.height+r,height:s.rec.height+20,width:s.rec.width+20,color:PDFLib.rgb(0,.8,1)}),e.drawText(n,l);let h=d+s.rec.lineCount;return e.drawText(new Date(c).toLocaleString(),{x:20,y:a-h*r,size:8,font:t}),h+1}function customerImage(e,t,n,o,i,a,r,c,g){let d=i+2+1;e.drawText("Customer",{x:20,y:r-i*c,size:c,font:t}),e.drawImage(n,{x:20,y:r-d*c-n.scale(o).height,width:n.scale(o).width,height:n.scale(o).height});let s=d+n.scale(o).height/c+1;return e.drawText(new Date(g).toLocaleString(),{x:20,y:r-s*c,size:8,font:t}),s+1}function agentText(e,t,n,o,i,a,r,c){let g=o+2,d=g+1,s=newPageNeeded_rec_txt(e,t,n,o,i,a,r);e.drawText("Genesys",{x:i-70,y:a-o*r,size:r,font:t});let l={x:i-s.rec.width-20,y:a-g*r,maxWidth:i-40,wordBreaks:[" "],font:t,size:r,lineHeight:r};e.drawRectangle({x:i-s.rec.width-30,y:a-d*r-s.rec.height+r,height:s.rec.height+20,width:s.rec.width+20,color:PDFLib.rgb(.8,.6,0)}),e.drawText(n,l);let h=d+s.rec.lineCount;return e.drawText(new Date(c).toLocaleString(),{x:i-100,y:a-h*r,size:8,font:t}),h+1}function agentImage(e,t,n,o,i,a,r,c,g){let d=i+2+1;e.drawText("Genesys",{x:a-70,y:r-i*c,size:c,font:t}),e.drawImage(n,{x:a-(n.scale(o).width+20),y:r-d*c-n.scale(o).height,width:n.scale(o).width,height:n.scale(o).height});let s=d+n.scale(o).height/c+1;return e.drawText(new Date(g).toLocaleString(),{x:a-100,y:r-s*c,size:8,font:t}),s+1}function newPageNeeded_rec_img(e,t,n,o,i){let a=!1;return n-(t+2+1)*i-o+i<5&&(a=!0),a}function newPageNeeded_rec_txt(e,t,n,o,i,a,r){let c=o+2+1,g=!1,d=drawMultilineText(e,n,{maxWidth:i-40,wordBreaks:[" "],font:t,size:r,lineHeight:r});return a-c*r-d.height+r<5&&(g=!0),{value:g,rec:d}}function drawMultilineText(e,t,n){const o=PDFLib.breakTextIntoLines(t,n.wordBreaks||e.doc.defaultWordBreaks,n.maxWidth,(e=>n.font.widthOfTextAtSize(e,n.size))),i=o.length,a=i*n.lineHeight;return{width:Math.max(...o.map((e=>n.font.widthOfTextAtSize(e,n.size)))),height:a,lineCount:i}}Genesys("subscribe","Launcher.ready",(function(){JSON.parse(localStorage.getItem(`_${gc_deploymentId}:actmu`))?(gc_token=JSON.parse(localStorage.getItem(`_${gc_deploymentId}:actmu`)).value,displayButton()):setTimeout((function(){gc_token=JSON.parse(localStorage.getItem(`_${gc_deploymentId}:actmu`)).value,displayButton()}),2e3)}));const downLoadSvgBlack='<svg xmlns="http://www.w3.org/2000/svg" enable-background="new 0 0 24 24" height="24px" viewBox="0 0 24 24" width="24px" fill="#000000"><g><rect fill="none" height="24" width="24"/></g><g><path d="M5,20h14v-2H5V20z M19,9h-4V3H9v6H5l7,7L19,9z"/></g></svg>',waitingLoadSvgBlack='<svg xmlns="http://www.w3.org/2000/svg" enable-background="new 0 0 24 24" height="24px" viewBox="0 0 24 24" width="24px" fill="#000000"><g><rect fill="none" height="24" width="24"/></g><g><path d="M18,22l-0.01-6L14,12l3.99-4.01L18,2H6v6l4,4l-4,3.99V22H18z M8,7.5V4h8v3.5l-4,4L8,7.5z"/></g></svg>',downLoadSvgWhite='<svg xmlns="http://www.w3.org/2000/svg" enable-background="new 0 0 24 24" height="24px" viewBox="0 0 24 24" width="24px" fill="#FFFFFF"><g><rect fill="none" height="24" width="24"/></g><g><path d="M5,20h14v-2H5V20z M19,9h-4V3H9v6H5l7,7L19,9z"/></g></svg>',waitingLoadSvgWhite='<svg xmlns="http://www.w3.org/2000/svg" enable-background="new 0 0 24 24" height="24px" viewBox="0 0 24 24" width="24px" fill="#FFFFFF"><g><rect fill="none" height="24" width="24"/></g><g><path d="M18,22l-0.01-6L14,12l3.99-4.01L18,2H6v6l4,4l-4,3.99V22H18z M8,7.5V4h8v3.5l-4,4L8,7.5z"/></g></svg>';function displayButton(){let e=document.createElement("button");e.onclick=function(){loadingOn(),setupWSS()},e.id="gc_downloadButton",e.style=`cursor: pointer;\n      box-shadow: rgba(0, 0, 0, 0.2) 0px 3px 5px -2px, rgba(0, 0, 0, 0.14) 0px 1px 4px 2px, rgba(0, 0, 0, 0.12) 0px 1px 4px 1px;\n      position: fixed !important;\n      bottom: 24px !important;\n      width: 56px;\n      height: 56px;\n      right: 96px !important;\n      border-radius: 50%;\n      background-color: ${gc_hexColor};\n      z-index: 9999;\n      border: 0px;`,"white"==gc_iconColor?e.innerHTML=downLoadSvgWhite:e.innerHTML=downLoadSvgBlack,document.body.appendChild(e)}function loadingOn(){let e=document.getElementById("gc_downloadButton");"white"==gc_iconColor?e.innerHTML=waitingLoadSvgWhite:e.innerHTML=waitingLoadSvgBlack}function loadingOff(){let e=document.getElementById("gc_downloadButton");"white"==gc_iconColor?e.innerHTML=downLoadSvgWhite:e.innerHTML=downLoadSvgBlack}function showError(){Genesys("command","Toaster.open",{title:"Error",body:"Sorry but there is no conversation currently to download. Please have a conversation first before trying to download the transcript."},(function(){}),(function(e){console.log("There was an error running the Toaster.open command:",e)}))}